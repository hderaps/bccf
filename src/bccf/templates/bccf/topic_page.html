{% extends "bccf/bccf_page.html" %}

{% load static bccf_big_marquee_tags content_carousel_tags %}

{% block marquee %}
{% big_marquee_for page %}
{% endblock %}

{% block carousels %}
{% content_carousel_for_topic page 'parent' %}
{% content_carousel_for_topic page 'professional' %}
{% endblock %}

{% block page_script %}
<script type="text/javascript" >
$(function() {
    $('.to-carousel').owlCarousel({
        'singleItem': true,
        'pagination': false,
        'addClassActive': true,  
    });
    
    $('.carousel-grid').hide();
    
    $('#slide-container').owlCarousel({
        'singleItem': true,
        'autoPlay': 5000,
        'autoHeight': true,
        'theme': "big-marquee",
    });
    $(window).on('resize', function(e) {
        if($(window).width() <= 724) {
            $('.to-slide').trigger('click');
        }
    });  
});

/** EVENT LISTENTERS **/
$('.page-box').on('click', function(e) {
    e.preventDefault();
    window.location.href = $(this).find('a').attr('href');
});

$('.control-buttons').on('click', 'a', function(e) {
    e.preventDefault();
    parent = $(this).parents('.content-pages');
    if($(this).hasClass('to-grid')) {
        parent.find('.carousel-slide').hide();
        parent.find('.carousel-grid').show();
    } else {
        parent.find('.carousel-grid').hide();
        parent.find('.carousel-slide').show();
    }
});

$('.content-pages').on('click', 'a[class^="button"]', function(e) {
    e.preventDefault();
    var carousel = $(this).siblings('.page-container-outer').children('div[class^="carousel"]:visible');
    if($(this).hasClass('button-prev')) {
        carousel.trigger('owl.prev');
    } else {
        var parent = $(this).parents('.content-pages');
        if(carousel.find('.active').is(':last-child')) {
            var offset = carousel.find('.owl-item .page-box').length;
            if(offset % 1 === 0) {
                $.ajax({
                    url: '/next/{{ page.slug }}/'+parent.attr('id')+'/'+offset+'/',
                    success: function(data) {
                        json = $.parseJSON(data);
                        if(json.length > 0) {                    
                            add_slide(json, parent);
                            add_grid(json, parent);
                            if(carousel.hasClass('carousel-slide')) {
                                parent.find('.carousel-grid').hide();                     
                            } else {
                                parent.find('.carousel-slide').hide();
                            }
                        }
                        carousel.trigger('owl.next');
                    },
                });
            }        
        } else {
            carousel.trigger('owl.next');
        }            
    }
});

var add_slide = function(data, parent) {
    var new_slide = $('<div>');
    var new_list = $('<ul>', {
        class:'page-container-inner',        
    });
    var carousel = parent.find('.carousel-slide');
    new_slide.append(new_list);
    carousel.data('owlCarousel').addItem(new_slide);
    for(var i=0; i < data.length; i++) {
        if(i !== 0 && i%4===0) {
            new_slide = $('<div>');
            var new_list = $('<ul>', {
                class:'page-container-inner',        
            });
            new_slide.append(new_list);
            carousel.data('owlCarousel').addItem(new_slide);
        }
        var new_page = $('<li>', {
            class: 'page-box carousel-box col four'
        });
        new_page.append($('<img>', {
            //src: '/media/'+data[i].fields.image,
            alt: data[i].fields.title
        }));
        var new_info = $('<div>');
        var new_link = $('<a>', {
            'href': '/{{ page.title }}/'+data[i].fields.slug
        });
        new_link.append('<h2>'+data[i].fields.title+'</h2>');
        new_info.append(new_link);
        new_info.append('<p class="no-tablet">'+data[i].fields.description.substr(0,30)+'</p>');
        new_page.append(new_info);
        new_list.append(new_page);
    }
};

var add_grid = function(data, parent) {
    var new_slide = $('<div>');
    var new_list = $('<ul>', {
        class:'page-container-inner',        
    });
    var carousel = parent.find('.carousel-grid');
    new_slide.append(new_list);
    carousel.data('owlCarousel').addItem(new_slide);
    for(var i=0; i < data.length; i++) {
        if(i !== 0 && i%3===0) {
            new_list.append('<li class="grid-content reset col twelve"></li>');
            continue;
        }
        if(i !== 0 && i%13===0) {
            new_slide = $('<div>');
            var new_list = $('<ul>', {
                class:'page-container-inner',        
            });
            new_slide.append(new_list);
            carousel.data('owlCarousel').addItem(new_slide);
        }
        var new_page = $('<li>', {
            class: 'page-box carousel-box col four'
        });
        new_page.append($('<img>', {
            //src: '/media/'+data[i].fields.image,
            alt: data[i].fields.title
        }));
        var new_info = $('<div>');
        var new_link = $('<a>', {
            'href': '/{{ page.title }}/'+data[i].fields.slug
        });
        new_link.append('<h2>'+data[i].fields.title+'</h2>');
        new_info.append(new_link);
        new_info.append('<p class="no-tablet">'+data[i].fields.description.substr(0,30)+'</p>');
        new_page.append(new_info);
        new_list.append(new_page);
    }
};   

</script>
{% endblock %}