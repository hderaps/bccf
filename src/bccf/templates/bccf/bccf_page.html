{% extends 'base.html' %}
{% load static bccf_rating_tags content_carousel_tags bccf_big_marquee_tags mezzanine_tags %}

{% block main %}
<div id="content-page-wrapper" class="section"> <!-- Main Wrapper -->
  <section id="main-content-side" class="col eight mobile-full"><!-- Left Side -->
      {% block marquee %}{% endblock %}
      <section id="page-header" class="section">
          {% block content %}
          <article class="col twelve">
            <h1>{% editable page.title %}{{ page.title }}{% endeditable %}</h1>
            {% editable page.content %}{{ page.content|safe }}{% endeditable %}
          </article>
          {% endblock %}
      </section>
      {% block carousels %}{% endblock %}
  </section>

<!-- #main-content-side "Left Side" -->

 <aside id="sidebar" class="col four mobile-full"> <!-- Right Side -->
    {% content_carousel_for_tag %}
     <div id="side-resources" class="section">
     	<div class="res-container">
            <div class="res-box">
                <em>SUGGESTED RESOURCES</em>
                {% content_carousel_for_resources %}
            </div>
       </div>
     </div> <!-- end of #side-resources -->
  </aside>
</div> <!-- end of #content-page-wrapper -->

{% block mobile_container %}
<div id="mobile-content-container" class="no-desktop no-tablet mobile-content-container">
    <a class="close-btn" href="#">CLOSE</a>
    <div class="mobile-content"></div>
</div>
{% endblock %}

{% block page_script %}
<script type="text/javascript" >
var open_baby = false;
$(function() {
    $('.to-carousel').owlCarousel({
        'singleItem': true,
        'pagination': false,
        'addClassActive': true,
        'startDragging': function(){ reset(); },
        'beforeMove': function() { reset(); },    
    });
    $('.carousel-grid').hide();
    reset();    
    
    {% if child %}
    
    {% if baby %}        
    open_baby = true;
    {% endif %}
    
    $('#{{ child }}:visible').trigger('click');
    
    {% endif %}    

    $('#slide-container').owlCarousel({
        'singleItem': true,
        'autoPlay': 5000,
        'autoHeight': true,
        'theme': "big-marquee",
    });
    $(window).on('popstate', function(e) {
        e.preventDefault();
    	console.log('woulda reload the page to ' + location.pathname + ' here, but won\'t');
        //window.location.href = location.pathname
    });
    $(window).on('resize', function(e) {
        reset();
        if($(window).width() <= 724) {
            $('.to-slide').trigger('click');
        }
    });  
});

/** EVENT LISTENTERS **/
$('.page-box').on('click', function(e) {
    e.preventDefault();
    reset();
    if(!$(this).hasClass('page-box-active')) { // was the active one clicked?
        pageURL = $(this).find('a').attr('href');
        if(open_baby) {
            pageURL = pageURL+'{{ baby }}';
            open_baby = false;          
        }
        $(this).addClass('page-box-active');
        load_content($(this));
    } else {
        $(this).removeClass('page-box-active');    
    }
});

$('.control-buttons').on('click', 'a', function(e) {
    e.preventDefault();
    reset();
    parent = $(this).parents('.content-pages');
    if($(this).hasClass('to-grid')) {
        parent.find('.carousel-slide').hide();
        parent.find('.carousel-grid').show();
    } else {
        parent.find('.carousel-grid').hide();
        parent.find('.carousel-slide').show();
    }
});

$('#mobile-content-container').on('click', '.close-btn', function(e) {
    e.preventDefault();
    reset();
});

$('.content-pages').on('click', 'a[class^="button"]', function(e) {
    e.preventDefault();
    var carousel = $(this).siblings('.page-container-outer').children('div[class^="carousel"]:visible');
    if($(this).hasClass('button-prev')) {
        carousel.trigger('owl.prev');
    } else {
        var parent = $(this).parents('.content-pages');
        if(carousel.find('.active').is(':last-child')) {
            var offset = carousel.find('.owl-item .page-box').length;
            if(offset % 1 === 0) {
                $.ajax({
                    url: '/next/{{ page.slug }}/'+parent.attr('id')+'/'+offset+'/',
                    success: function(data) {
                        json = $.parseJSON(data);
                        if(json.length > 0) {                    
                            add_slide(json, parent);
                            add_grid(json, parent);
                            if(carousel.hasClass('carousel-slide')) {
                                parent.find('.carousel-grid').hide();                     
                            } else {
                                parent.find('.carousel-slide').hide();
                            }
                        }
                        carousel.trigger('owl.next');
                    },
                });
            }        
        } else {
            carousel.trigger('owl.next');
        }            
    }
});

/** HELPER FUNCTIONS **/
var reset = function() {
    $('.reset').hide().html('');
    $('#mobile-content-container').hide()
    $('#mobile-content-container .mobile-container').html('');
    $('.page-box-active').removeClass('page-box-active');
    $('body').css({overflow: 'auto', height: 'auto'});
};

var load_content = function(box) {
    var container = null
    var loader =  $('<img>', {
        src: '{% static "img/bccf-loader.gif" %}',
        alt: 'Loader',
        class: 'ajax-loader',
    });
    if($(window).width() <= 724) { // For mobiles
        $('body').css({overflow: 'hidden', height: '100%'});
        $('#mobile-content-container').show();
        container = $('#mobile-content-container .mobile-content');
    } else if(box.parents('.carousel-slide').length) {
        container = box.parents('.carousel-slide').siblings('.slide-content');
    } else if(box.parents('.carousel-grid').length) {
        container = box.nextAll('.grid-content').first();
    }
    container.html(loader).show();
    $.ajax({
        url: pageURL+'?type=ajax',
        success: function(data) {
            container.html(data);
            
            if($(window).width() >= 724) {
                $('body, html').animate({
                    'scrollTop':   container.offset().top-160
                }, 500);
            }
        }
    });
    if (pageURL != window.location) {
        window.history.pushState({ path: pageURL }, '', pageURL);
    }
}

var add_slide = function(data, parent) {
    var new_slide = $('<div>');
    var new_list = $('<ul>', {
        class:'page-container-inner',        
    });
    var carousel = parent.find('.carousel-slide');
    new_slide.append(new_list);
    carousel.data('owlCarousel').addItem(new_slide);
    for(var i=0; i < data.length; i++) {
        if(i !== 0 && i%4===0) {
            new_slide = $('<div>');
            var new_list = $('<ul>', {
                class:'page-container-inner',        
            });
            new_slide.append(new_list);
            carousel.data('owlCarousel').addItem(new_slide);
        }
        var new_page = $('<li>', {
            class: 'page-box carousel-box col four'
        });
        new_page.append($('<img>', {
            //src: '/media/'+data[i].fields.image,
            alt: data[i].fields.title
        }));
        var new_info = $('<div>');
        var new_link = $('<a>', {
            'href': '/{{ page.title }}/'+data[i].fields.slug
        });
        new_link.append('<h2>'+data[i].fields.title+'</h2>');
        new_info.append(new_link);
        new_info.append('<p class="no-tablet">'+data[i].fields.description.substr(0,30)+'</p>');
        new_page.append(new_info);
        new_list.append(new_page);
    }
};

var add_grid = function(data, parent) {
    var new_slide = $('<div>');
    var new_list = $('<ul>', {
        class:'page-container-inner',        
    });
    var carousel = parent.find('.carousel-grid');
    new_slide.append(new_list);
    carousel.data('owlCarousel').addItem(new_slide);
    for(var i=0; i < data.length; i++) {
        if(i !== 0 && i%3===0) {
            new_list.append('<li class="grid-content reset col twelve"></li>');
            continue;
        }
        if(i !== 0 && i%13===0) {
            new_slide = $('<div>');
            var new_list = $('<ul>', {
                class:'page-container-inner',        
            });
            new_slide.append(new_list);
            carousel.data('owlCarousel').addItem(new_slide);
        }
        var new_page = $('<li>', {
            class: 'page-box carousel-box col four'
        });
        new_page.append($('<img>', {
            //src: '/media/'+data[i].fields.image,
            alt: data[i].fields.title
        }));
        var new_info = $('<div>');
        var new_link = $('<a>', {
            'href': '/{{ page.title }}/'+data[i].fields.slug
        });
        new_link.append('<h2>'+data[i].fields.title+'</h2>');
        new_info.append(new_link);
        new_info.append('<p class="no-tablet">'+data[i].fields.description.substr(0,30)+'</p>');
        new_page.append(new_info);
        new_list.append(new_page);
    }
};   

</script>
{% endblock %}

{% endblock %}